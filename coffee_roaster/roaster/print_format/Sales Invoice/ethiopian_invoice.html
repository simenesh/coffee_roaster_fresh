<style>
  .invoice-header { text-align:center; font-weight:bold; font-size:18px; margin-bottom:10px; }
  .company-info, .customer-info, .invoice-meta { font-size:12px; }
  .invoice-table th, .invoice-table td { font-size:12px; border:1px solid #000; padding:4px; }
  .invoice-summary td { font-size:12px; }
  .footer { margin-top:40px; font-size:12px; text-align:center; }
</style>

<div class="invoice-header">ደረሰኝ<br>SALES INVOICE</div>

<!-- Company block (no headings before values) -->
<div class="company-info">
  <strong>{{ frappe.db.get_value("Company", doc.company, "company_name") or doc.company }}</strong><br>
  {{ frappe.db.get_value("Company", doc.company, "tax_id") or "" }}<br>
  {% set comp_addr = doc.company_address %}
  {{ frappe.db.get_value("Address", comp_addr, "phone")
     or frappe.db.get_value("Address", comp_addr, "phone_no")
     or "" }}<br>
  {{ frappe.db.get_value("Address", comp_addr, "address_display") or "" }}
</div>

<hr>

<div class="invoice-meta">
  <b>Invoice No:</b> {{ doc.name }}<br>
  <b>Date:</b> {{ doc.posting_date }}
</div>

<!-- Customer block (pulls missing fields safely) -->
<div class="customer-info">
  <b>Customer:</b> {{ doc.customer_name }}<br>
  {% set cust_tax = doc.tax_id or frappe.db.get_value("Customer", doc.customer, "tax_id") %}
  <b>TIN:</b> {{ cust_tax or "" }}<br>
  {% set cust_addr = doc.customer_address %}
  <b>Phone:</b> {{ frappe.db.get_value("Address", cust_addr, "phone")
                   or frappe.db.get_value("Address", cust_addr, "phone_no")
                   or "" }}<br>
  <b>Address:</b> {{ frappe.db.get_value("Address", cust_addr, "address_display") or "" }}
</div>

<hr>

<table class="invoice-table" width="100%" cellspacing="0" cellpadding="2">
  <thead>
    <tr><th>#</th><th>Item</th><th>Unit</th><th>Qty</th><th>Rate</th><th>Amount</th></tr>
  </thead>
  <tbody>
    {% for row in doc.items or [] %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ row.item_name }}</td>
      <td>{{ row.uom or "Unit" }}</td>
      <td>{{ row.qty }}</td>
      <td>{{ row.rate }}</td>
      <td>{{ row.amount }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<br>

{# --- TAX SECTION: robust VAT display --- #}
{% set vat_total = 0 %}
{% set vat_rate = None %}
{% set tax_rows = [] %}

{% for tax in doc.taxes or [] %}
  {% set _ = tax_rows.append(tax) %}
  {% if "VAT" in (tax.account_head or "") or "VAT" in (tax.description or "") %}
    {% set vat_total = vat_total + (tax.tax_amount or 0) %}
    {% if vat_rate is none and tax.rate is not none %}{% set vat_rate = tax.rate %}{% endif %}
  {% endif %}
{% endfor %}

<table class="invoice-summary" width="45%" align="right" cellspacing="0" cellpadding="2">
  <tr>
    <td><b>Subtotal:</b></td>
    <td>{{ doc.net_total }}</td>
  </tr>

  {% for tax in tax_rows %}
    <tr>
      <td><b>{{ (tax.description or tax.account_head) | trim }}{% if tax.rate %} ({{ tax.rate }}%){% endif %}</b></td>
      <td>{{ tax.tax_amount }}</td>
    </tr>
  {% endfor %}

  {% if vat_total %}
    <tr>
      <td><b>VAT{% if vat_rate is not none %} ({{ vat_rate }}%){% endif %}</b></td>
      <td>{{ vat_total }}</td>
    </tr>
  {% endif %}

  <tr>
    <td><b>Total (Incl. Taxes):</b></td>
    <td>{{ doc.grand_total }}</td>
  </tr>

  {% if doc.rounding_adjustment %}
  <tr>
    <td><b>Rounding:</b></td>
    <td>{{ doc.rounding_adjustment }}</td>
  </tr>
  {% endif %}

  {% if doc.rounded_total %}
  <tr>
    <td><b>Rounded Total:</b></td>
    <td>{{ doc.rounded_total }}</td>
  </tr>
  {% endif %}
</table>

<div class="footer">
  <br><br>
  <strong>Signature: ___________________________</strong><br>
  Thank you for your business!
</div>
